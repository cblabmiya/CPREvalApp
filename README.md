# 胸骨圧迫判定システム
このアプリケーションは胸骨圧迫(心臓マッサージ)が正しく行えているかをカメラを通して判定するシステムである。
心肺蘇生法(cardiopulmonary resuscitation: CPR)の一部分の判定を担うので、CPREvalAppとしている。

- [ここをクリックして、とにかく利用してみる。](https://www.cc.miyazaki-u.ac.jp/cblab/CPREvalApp/app.html)

## はじめに
近年、高齢化が進み、救急需要が高まっている。中でも一般市民による救助が必要な心肺蘇生において、多くの人が不安を感じている[1]。この不安を解消するために、救急用のアプリケーションが開発されている[2]。しかし、現時点では救助者の動きを評価するものがなく、救助者の不安を取り除けているとは言えない。  
このアプリケーションは救助者の不安を取り除くために、リアルタイムに救助者の胸骨圧迫を判定するためのWebアプリケーションである。実際の現場や訓練で利用することを想定している。

## 使い方
操作は以下の手順で行う。  
1.  利用条件の確認。
2.	URLをWebブラウザで入力してアプリケーションを開く。
3.	救助者の手首から肘の長さの実寸を選択する。(1回のみ,おおよそで良い)
4.	カメラが起動するまでにチュートリアルを確認する。
5.	カメラ起動後、画面をクリックまたはタップして判定開始する。
6.	判定開始後、撮影者は救助者を画面の赤枠内に入れ、救助者は胸骨圧迫を実行する。
7.  判定結果の確認。
8.	救助終了後、録画保存ボタンを押して、録画ファイルをダウンロードする。

「カメラ反転」ボタンはアウトカメラがある場合に、インカメラとアウトカメラが切り替わる。  
「やり直し」ボタンはアプリケーションがリロードされる。

### 1.  利用条件の確認
- このアプリケーションは、実際の現場で利用する場合は救助者と撮影者がいることを前提としている。撮影者が救助者と1m程度離れた場所で正面から撮影する。可能であれば、スマートフォンやタブレットの画面が救助者に見えるようにインカメラで撮影する。撮影をアウトカメラに変更することも可能で、その場合はスマートフォンやタブレットの判定結果の音声が救助者に聞こえるようにする。  
- スマートフォンやタブレットは縦方向で撮影することを推奨している。
- 訓練として利用する場合は、パソコンやタブレットのインカメラを利用する。デフォルトでは音が大きく出るため、WindowsやAndroidではアプリケーション内の音量で調整する。iOSやMacの場合の音量調整はON/OFFとなっている。

### 2．URLをWebブラウザで入力してアプリケーションを開く。
このアプリケーションはWebブラウザで[https://www.cc.miyazaki-u.ac.jp/cblab/CPREvalApp/app.html](https://www.cc.miyazaki-u.ac.jp/cblab/CPREvalApp/app.html)にアクセスすることで利用できる。パソコン、スマートフォン、タブレットで利用可能である。次の端末環境は実行可能であることは確認している。  
- Windows 10: Google Chrome(バージョン: 122.0.6261.129), Firefox(バージョン:123.0.1 (64 ビット))
- Google Pixel 6a: Google Chrome(バージョン: 122.0.6261.129)
- iPhone SE 2 (iOS 17.4): Safari
- iPad(第8世代) (iPadOS 17.4): Safari

### 3．救助者の手首から肘の長さの実寸を選択する。(1回のみ,おおよそで良い)
- 救助者の手首から肘の長さを画面上部で選択する。
- 選択されたときにURLが更新される。
- ｈｔｔｐｓ://oooo?len=25のようにURLのパラメタに長さが設定されるので、あらかじめ手首から肘の長さのURLを保存(ブックマーク)しておくと、利用時には手首から肘の長さを変更する必要がない。

### 4．カメラが起動するまでにチュートリアルを確認する。
- 最初にアプリケーションを起動したとき、カメラや音声の許可を求めらるので許可する。
- SafariやGoogle Chromeの場合は毎回許可を求められることがあるので、Webブラウザの権限で許可を求めないように設定するとよい。
- カメラが起動するまでに時間がわずかにあるので、救助者の手の組み方、胸骨の位置、撮影方法をイラストで確認する。

### 5．カメラ起動後、画面をクリックまたはタップして判定開始する。
- カメラが起動すると、チュートリアルの後ろにカメラ映像が出てくる。
- 画面上部に「画面をクリックでスタート」が出ればカメラ準備OK。
- チュートリアルを読んで問題なければ、チュートリアルを含むカメラ映像の画面部分をクリックまたはタップすることで判定開始する。

### 6．判定開始後、撮影者は救助者を画面の赤枠内に入れ、救助者は胸骨圧迫を実行する。
- 判定開始後、撮影者はカメラ映像で救助者を画面の赤枠内に入れる。このとき、救助者の両肩、両肘、両手の位置が赤丸、肩-肘-手の間が緑線で表示される。
- 救助者は傷病者の胸骨に両手を当て、腕を伸ばして、0.5秒に1回で5cmの圧迫を開始する。

### 7．判定結果の確認
- 判定結果は画面内の文字表示と、15回の圧迫に1回の音声で確認ができる。
- 圧迫回数は15回を1setとし、setごとで5秒以上で圧迫していない場合は回数がリセットされる。set数はリセットされない。
- 救助者が赤枠内に入っておらず、正しい姿勢をしていない場合は、画面中央に「正面から撮影」「手は肩より内側」という文字とイラストが出る。また、判定の文字に「救助者：OUT」と赤文字で表示される。判定可能な場合は「救助者:準備OK」と表示され、画面中央に文字とイラストは表示されない。
- 1回の圧迫にかかった時間をテンポ。腕の伸びを姿勢。圧迫の深さを深さ。で判定結果を文字で表示される。
- 正しい圧迫ではない場合は赤文字になる。
- 音声は下記の条件で流れる。  

| 条件 | 音声 |
| ---- | ---- |
| 問題がない | その調子です |
| 15回中に姿勢を維持できた時間が約3割以下 | 姿勢が悪いです |
| 15回中3回以上で深さが4.5cm未満 | もう少し強く押しましょう |
| 15回にかかった時間が6.75秒未満 | 少し早いです |
| 15回にかかった時間が9.75秒以上 | 少し遅いです |
| 15回を6.75～9.75秒以内に圧迫しているが、8回以上0.45～0.65秒のテンポで押せていない | テンポが乱れています |


### 8．救助終了後、録画保存ボタンを押して、録画ファイルをダウンロードする
- 「停止」ボタンを押すと「録画保存」ボタンが有効になる。
- 「録画保存」ボタンを押すと、それまで録画した映像がダウンロード可能となる。録画した映像にはモザイクがかかっている。

# [使い方は理解したので、ここをクリックして利用する。](https://www.cc.miyazaki-u.ac.jp/cblab/CPREvalApp/app.html)




## 技術(方法)
### MoveNetを使った姿勢推定
MoveNet[3]は姿勢推定の推論の結果として、身体の部位を示す17個のキーポイントがあり、キーポイントの座標情報、検出精度を出力する。このアプリでは、MoveNetで推論されたキーポイントから両肩、両肘、両手首を利用した。

### 姿勢や動作の判定
判定は、日本赤十字社が公開している胸骨圧迫の方法[4]を参考にして、救助者の姿勢、圧迫の深さ、テンポを判定した。  
姿勢の判定は、腕が真っ直ぐに伸びているかを判定する。手首と肘と肩のキーポイントの位置関係から肘の角度を判定した。この角度が160度以上であれば判定は良いとした。  
圧迫の深さは、まず動作の判定として、キーポイントの画像中の縦方向(y軸)の動きを用いた。胸骨を押し始めるときと、押してから元の位置に戻ろうとするときで、経時的なフレーム間で座標の差が正負に切り替わる。この正負の切り替えがされる位置の座標の差分を圧迫の深さとした。このとき、僅かな動きで移動を検知しないような仕組みを用いた[5]。深さの実際の長さは手首から肘の長さを元にして、画像中の移動距離から計算した。4～6cmの圧迫で判定は良いとした。  
テンポは圧迫がカウントされてから、次にカウントされるまでの時間とした。胸骨圧迫は、1分間に100～120回のテンポで行う必要がある。
そこから、1回あたり0.45～0.65秒となっていれば、テンポの判定は良いとした。

### 音声補助
音声補助は、胸骨圧迫の判定結果や参考となるテンポを音声によって支援する機能として利用した。胸骨圧迫の判定結果は、圧迫を15回行うたびに結果を音声で伝えるようにした。テンポはメトロノームのようにして、1分間に110回を等間隔で音を鳴らしてテンポの目安とした。  
音声にはVOICEVOX(春日部つむぎの音声)[6]で音声合成をしたものを利用した。

### 録画
録画は判定が開始されてから終了するまでの映像を記録することとした。判定システム画面で「録画保存」ボタンを押すと、それまで録画した映像がダウンロード可能となる。救助者、傷病者ともにプライバシー保護のため、録画した映像にはモザイクをかけた。

### アプリケーションの限界
- MoveNetを使用しているため、MoveNetで検出できない状況では利用できない。例えば、厚手の服を着ているときには、推定が難しいことがある。また、複数人がカメラに映っているときに、誰が救助者であるかを判定していないため、傷病者以外は救助者1人を正面から撮影する必要がある。
- 一般的に使われるカメラ映像を想定しているため、実際の長さ(実寸)は正確には測れていない。正面から撮影し、腕が伸びた状態であれば、実寸に近い値で深さを判定することができる。
- Webアプリケーションのため、このアプリのURLにアクセスできる(インターネット)環境が必要である。

### 今後の課題
- 実寸を計測する方法としてvisual SLAMを利用。
- スマホアプリ版の開発。
- 心肺蘇生訓練人形を用いるなどして、システムの判定と実際の判定を検証。


## 参考文献
[1]	令和３年度救急・救助の現況　日本心臓財団(https://www.jhf.or.jp/pro/info/kyukyu.html)  
[2]	渋谷卓磨, 渡邊宏尚, 土田栞, 小林絵里奈, 村山沙樹, 皆月昭則, Kinect を用いた心肺蘇生時の姿勢確認学習支援アプリケーションの開発, 情報科学技術フォーラム講演論文集, vol.14, No.3, 401-402, 2015.  
[3]	MoveNet(https://www.tensorflow.org/hub/tutorials/movenet?hl=ja)  
[4]	日本赤十字社-心肺蘇生(https://www.jrc.or.jp/study/safety/airway/)  
[5]	https://github.com/kntrinoue/extremepoints  
[6]	VOICEVOX (https://voicevox.hiroshiba.jp/)   


## アンケート
アプリケーションの改善のため、アンケートを実施しています。
利用した方は下記から回答していただけますと、モチベーションや改善に役立てたいと思います。  
[ここをクリックしてアンケートに回答する](https://forms.office.com/r/Jh3VjREVKA)  
<a href="https://forms.office.com/r/Jh3VjREVKA"><img src="胸骨圧迫判定アプリアンケートQRコード.png" width=200></a>


---
(c) 宮崎大学工学部 井上研究室
